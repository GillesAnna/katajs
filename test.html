<html><head> 
 
 
<title>GLGE</title> 
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
 
 
<script type="text/javascript" src="pdebug.js"></script> 
<script type="text/javascript" src="GLGE/external/sylvester.src.js"></script> 
<script type="text/javascript" src="GLGE/external/glutils.js"></script> 
<script type="text/javascript" src="GLGE/glge.js"></script> 
<script type="text/javascript" src="GLGE/glge_input.js"></script> 
<script type="text/javascript" src="ray_tri.js"></script> 
<script type="text/javascript" src="k3d.js"></script> 

<style>
body{background-color: #000;color: #fff;font-family:arial}
</style>
</head><body>

<div>
<div style="width:900px;margin:auto;position:relative" id="container">
<canvas id="canvas" width="900" 
height="500"></canvas>
<img src="images/glgelogo.png" alt="GLGElogo" style="position:absolute;top: 450px; left: 750px;" />
<div id="framerate" style="position:absolute; left: 750px; top: 20px; background-color: #000; opacity: 0.5;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<div id="debug" style="padding: 5px"></div>
</div>
<div onclick = 'alert("2D Javascript element")' style="padding: 5px;position:absolute; left: 20px; top: 370px; background-color: #000; opacity: 0.7;height: 100px; width: 400px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
<h2 style="margin:0;padding:0;padding-bottom: 5px;font-size: 20px">Extremely early Kata3D 'Demo'</h2>
<p style="margin:0;padding:0;padding-bottom: 5px;">Hover==cyan; selected==purple; drag objects</p>
<p style="margin:0;padding:0;padding-bottom: 5px;">arrow keys to move, U & J to pan camera</p>
<p style="margin:0;padding:0;padding-bottom: 5px;">this box pops a msg, so does the monkey</p>
</div>
</div>
</div>
<div id="debug2"></div>
<script type="text/javascript">

doc = new GLGE.Document("level.xml");
doc.onLoad = function(){
    scene = initGLGE()
    
    //document.getElementById("canvas").onmousedown=function(e){scene.pick(e.clientX-this.parentNode.offsetLeft,e.clientY-this.parentNode.offsetTop); }
    
    //pdebug("monkey object:" + scene.getObjectById("monkeyobject") + " is " + scene.getObjectById("monkeyobject").id)
    
    selected_mat = doc.getElement("purple");
    hover_mat = doc.getElement("cyan");
    pdebug("selected_mat: " + selected_mat + "hover_mat:" + hover_mat)
    
    var hoverable = ["crate2", "crate3", "crate5"]
    var selectable = ["crate2", "crate5"]
    var dragable = ["crate", "crate4", "crate5"]
    
    // function to safely set material and save original for highlighting (hover/select)
    setHighlightMaterial = function(obj, material){
        if (material != obj.highlightMaterial) {
            if (material == null) {
                obj.setMaterial(obj.originalMaterial)
            }
            else {
                if (obj.highlightMaterial == null) {
                    obj.originalMaterial = obj.getMaterial()
                }
                obj.setMaterial(material)
            }
            obj.highlightMaterial = material
        }
    }
    
    // hover cyan
    for (i in hoverable) {
        obj = scene.getObjectById(hoverable[i])
        obj.makeHoverable(function(){
            if (this.highlightMaterial != selected_mat) setHighlightMaterial(this, hover_mat)
        }, function(){
            if (this.highlightMaterial != selected_mat) setHighlightMaterial(this, null)
        })
        obj.highlightMaterial = null
    }
    
    
    // selected are purple
    for (i in selectable) {
        obj = scene.getObjectById(selectable[i])
        scene.getObjectById(selectable[i]).makeSelectable(function(){
            setHighlightMaterial(this, selected_mat)
        }, function(){
            if (this.highlightMaterial == selected_mat) setHighlightMaterial(this, null)
        })
        obj.highlightMaterial = null
    }
    
    // bullstuff drag just uses global x, z
    for (i in dragable) {
        scene.getObjectById(dragable[i]).makeDragable(function(){
            this.dragStartLocX = parseFloat(this.getLocX()) ///	wtf? strings?
            this.dragStartLocZ = parseFloat(this.getLocZ())
        }, function(dx, dy){
            this.setLocX(this.dragStartLocX - dx * .04)
            this.setLocZ(this.dragStartLocZ - dy * .04)
        })
	}
    
    //scene.getObjectById("monkeyobject").makeClickableCallback(function(x,y) {
    //	alert("MONKEY BIDNESS!")
    //	document.getElementById("canvas").buttonState[0]=false			///	kluge to fix bug where alert() makes GLGE miss mouseUp
    //})
    
    scene.getObjectById("teapotobject").makeClickableCallback(function(x, y){
        alert("Would you have some tea?")
        document.getElementById("canvas").buttonState[0] = false ///	kluge to fix bug where alert() makes GLGE miss mouseUp
    })
    
    scene.getObjectById("crate").makeClickableCallback(function(x, y){
        var p = this.getPositions()
        pdebug("crate positions length: " + p.length)
        
        // create raycast from camera to mouse xy
        var cam = scene.camera
        var mro = Matrix.rotMat(cam.getRotX(), cam.getRotY(), cam.getRotZ())
        var mlo = Matrix.transMat(cam.getLocX(), cam.getLocY(), cam.getLocZ())
        var mat = mlo.x(mro) // camera matrix    
        var mousepos = scene.mouse.getMousePosition();
        var w = 900.0
        var h = 500.0
        var mx = mousepos.x - document.getElementById("container").offsetLeft;
        var my = mousepos.y - document.getElementById("container").offsetTop;
        var focal = 1.1
        mx = focal * (mx / w - 0.5)
        my = -focal * (h / w) * (my / h - 0.5)
        pdebug("mx: " + mx + " my: " + my)
        var v = Vector.create([mx, my, -1, 1]) // camera points along -Z axis
        v = mat.x(v) // transform to camera matrix
        var P0 = [parseFloat(cam.getLocX()), parseFloat(cam.getLocY()), parseFloat(cam.getLocZ())]
        var vP0 = Vector.create(P0)
        var P1 = [v.e(1), v.e(2), v.e(3)]
        var R = [P0, P1]
        pdebug("R = [[" + R[0] + "],[" + R[1] + "]]")
        
        // get wall matrix
        mro = Matrix.rotMat(this.getRotX(), this.getRotY(), this.getRotZ()) // our rotation matrix
        mlo = Matrix.transMat(this.getLocX(), this.getLocY(), this.getLocZ()) // our location matrix
        mat = mlo.x(mro) // our full matrix
        // scale wall vertices
        var sx = parseFloat(this.getScaleX())
        var sy = parseFloat(this.getScaleY())
        var sz = parseFloat(this.getScaleZ())
        var minI = null
        var mindist = 999999.9
        for (var i = 0; i < p.length; i += 9) { // for each tri
            var A = Vector.create([sx * p[i], sy * p[i + 1], sz * p[i + 2], 1]) // get vertex points for triangle ABC
            var B = Vector.create([sx * p[i + 3], sy * p[i + 4], sz * p[i + 5], 1])
            var C = Vector.create([sx * p[i + 6], sy * p[i + 7], sz * p[i + 8], 1])
            A = mat.x(A) // convert them to global coords
            B = mat.x(B)
            C = mat.x(C)
            var T = [A.elements.slice(0, 3), B.elements.slice(0, 3), C.elements.slice(0, 3)]
            //		pdebug("T: " + T)
            var I = intersect_RayTriangle(R, T)
            if (I) {
                dist = vP0.distanceFrom(I)
                if (dist < mindist) {
                    mindist = dist
                    minI = I
                }
                //			pdebug("intersect: " + I.elements + " dist: " + dist)
                //			pdebug("T = [[" + T[0] +"],[ "+ T[1] +"],["+ T[2]+"]]")
            }
        }
        if (minI == null) {
            pdebug("no intersection found " + I + " mindist: " + mindist)
        }
        else {
            var monk = scene.getObjectById("monkeyobject")
            monk.setLocX(minI.elements[0])
            monk.setLocY(minI.elements[1])
            monk.setLocZ(minI.elements[2])
            monk.setRotX(this.getRotX())
            monk.setRotY(this.getRotY())
            monk.setRotZ(this.getRotZ())
            pdebug("intersect: " + minI.elements + " dist: " + mindist)
            pdebug("T = [[" + T[0] + "],[ " + T[1] + "],[" + T[2] + "]]")
        }
    })
    
}
</script>

<div id="dbg0"></div>
<div id="dbg1"></div>
<div id="dbg2"></div>
<div id="dbg3"></div>
<div id="dbg4"></div>
<div id="dbg5"></div>
<div id="dbg6"></div>
<div id="dbg"></div>
</body></html>
