<html><head> 
 
 
<title>GLGE</title> 
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
 
 
<script type="text/javascript" src="pdebug.js"></script> 
<script type="text/javascript" src="externals/GLGE/glge_math.js"></script> 
<script type="text/javascript" src="externals/GLGE/glge.js"></script> 
<script type="text/javascript" src="externals/GLGE/glge_input.js"></script> 
<script type="text/javascript" src="ray_tri.js"></script> 
<script type="text/javascript" src="k3d.js"></script> 

<style>
body{background-color: #000;color: #fff;font-family:arial}
</style>
</head><body>

<div>
	<div style="width:900px;margin:auto;position:relative" id="container">
		<canvas id="canvas" width="900" height="550"></canvas>
		<div id="framerate" style="position:absolute; left: 762px; top: 510px; background-color: #000; 
		opacity: 0.3;height: 30px; width: 130px; border-radius: 5px;	-moz-border-radius5px;-webkit-border-radius:5px;border: 1px solid #fff;">
			<div id="debug" style="padding: 5px"></div>
		</div>
		<div style="padding: 5px;position:absolute; left: 20px; top: 474px; 
		background-color: #000; opacity: 0.3;height: 59px; width: 105px; border-radius: 5px;	
		-moz-border-radius:5px;-webkit-border-radius:5px;border: 1px solid #fff;">
			<button onMouseDown='movementButton("fwd")' onMouseUp='movementButtonUp("fwd")' onMouseOut='movementButtonUp("fwd")' style="position:absolute;left:40;top:3">/\</button>
			<button onMouseDown='movementButton("back")' onMouseUp='movementButtonUp("back")' onMouseOut='movementButtonUp("back")' style="position:absolute;left:40;top:40">\/</button>
			<button onMouseDown='movementButton("left")' onMouseUp='movementButtonUp("left")' onMouseOut='movementButtonUp("left")' style="position:absolute;left:5;top:20"><</button>
			<button onMouseDown='movementButton("right")' onMouseUp='movementButtonUp("right")' onMouseOut='movementButtonUp("right")' style="position:absolute;left:75;top:20">></button>
		</div>
		<div align="center">
			<button onclick = 'addPicture("input_tex1")'>new painting:</button>
			<input type="text" id="input_tex1" size="50" value="images/jais_test512x512.jpg"/><br>
		</div>
		<div align="center">
			<form Name="input_editmode">
				<div id="editInfo" align="center">LOADING..LOADING..LOADING..LOADING..LOADING</div>
				<input type="radio" Name="R" onClick = 'editMode("safe")' Checked="true"/>safe
				<input type="radio" Name="R" onClick = 'editMode("move")'/>move
				<input type="radio" Name="R" onClick = 'editMode("resize")'/>resize
				<input type="radio" Name="R" onClick = 'editMode("annotate")'/>annotate
				<input type="radio" Name="R" onClick = 'editMode("delete")'/>delete
			</form>
		</div>
		<div id="galleryAnnotate" style="padding: 5px" align="center">
		</div>
		<div style="padding: 5px;position:absolute; left: 145px; top: 510px; 
			background-color: #000; opacity: 0.5;height: 22px; width: 595px; border-radius: 5px;	
			-moz-border-radius:5px;-webkit-border-radius:5px;border: 1px solid #fff;"
			id="galleryInfo" style="padding: 5px" align="center">
		</div>
		<div id="save" style="position:absolute; left: 10px; top: 550px;">
			<button onclick = 'saveGallery()'>save</button>
		</div>
		<div id="load" style="position:absolute; right: 10px; top: 550px;">
			<button onclick = 'loadGallery()'>load</button>
		</div>
	</div>
</div>
<div id="saveLoadGallery"></div>
<script type="text/javascript">

doc = new GLGE.Document();

// function to safely set material and save original for highlighting (hover/select)
setHighlightMaterial = function(obj, material){
    if (material != obj.highlightMaterial) {
        if (material == null) {
            obj.setMaterial(obj.originalMaterial)
        }
        else {
            if (obj.highlightMaterial == null) {
                obj.originalMaterial = obj.getMaterial()
            }
            obj.setMaterial(material)
        }
        obj.highlightMaterial = material
    }
}

niceArray = function (v, places) {
	r = []
	for (i in v) {
		r.push(v[i].toFixed(places))
	}
	return r
}

positionOnWall = function(obj, x, y){						// pass no x,y means use present mouse location
    var placeIndex = K3D.getNearestObject(g_dragOns,x,y)
    if (placeIndex) {
        var place = placeIndex[0]
        var over = g_dragOns[placeIndex[1]]
        var norm = new GLGE.Vec(placeIndex[2])
		
		// if we're on a floor or ceiling FIXME: we should still rotate so the picture orients to the camera
		if (Math.abs(norm.e(3)) > 0.8) {
			obj.setLocX(place[0])
			obj.setLocY(place[1])
			obj.setLocZ(place[2]+0.1*norm.e(3))
			obj.setRotX(Math.PI * -0.5 * -norm.e(3))
			obj.setRotY(0)
			obj.setRotZ(0)
		}
		
		// if we're on a wall
		else {
			var nx = norm.cross([0, -1, 0])
			var angZ = norm.angle([0, -1, 0])
			if (nx.e(3) > 0) 
			angZ = -angZ /// assuming approximately vertical
			//pdebug("dragWallUpdate: " + obj.id + " over: " + over + " place: " +
				//niceArray(place, 2) + " ang: " + angZ.toFixed(2) +" norm: " + niceArray(norm.data, 2), 9)
			over = scene.getObjectById(over)
			obj.setLocX(place[0]+norm.e(1)*0.1)
			obj.setLocY(place[1]+norm.e(2)*0.1)
			obj.setLocZ(place[2])
			obj.setRotX(over.getRotX())
			obj.setRotY(over.getRotY())
			obj.setRotZ(Math.PI + angZ)
		}
    }
}

setNote = function() {
	var newComment = document.getElementById("input_annotate").value
	if (g_picToAnnotate) g_picToAnnotate.galleryInfo = newComment
	document.getElementById("galleryInfo").innerHTML = newComment
	document.getElementById("galleryAnnotate").innerHTML = ""	
}

g_picToAnnotate=null
dragWallStart = function(x, y){
	this.dragWallStartScale = [this.getScaleX(), this.getScaleY(), this.getScaleZ()]
	// annotate
	if (document.input_editmode.R[3].checked) {
		g_picToAnnotate = this
		var html = 
		'<input type="text" id="input_annotate" size="100" value="type comment here"/><br><button  onclick="setNote()" >press here to enter comment</button>'
		document.getElementById("galleryAnnotate").innerHTML = html
		document.getElementById("galleryInfo").innerHTML = ""
	}
	// delete
	if (document.input_editmode.R[4].checked) {
		K3D.gameScene.removeObjectById(this.id)
	}
}

dragWallUpdate = function(dx, dy){
    if (document.input_editmode.R[1].checked) {
		positionOnWall(this)
	}
	else {
		if (document.input_editmode.R[2].checked) {
			var scale = 1.0 + 0.01 * dx
			if (scale<0.1) scale = 0.1
			//pdebug("scale: " + dx + " " + scale, 7)
			this.setScaleX(this.dragWallStartScale[0] * scale)
			this.setScaleZ(this.dragWallStartScale[2] * scale)
			this.computeBoundingSphere()
		}
	}
}

// create a new object with same props as old
shallowClone = function (obj) {
	o2 = {}
	for (i in obj) {
		o2[i] = obj[i]
	}
	return o2
}

pixnum=1

doc.onLoad = function(){
	var heightmap={
		image:"images/gallerymap.png",
		width:512,
		height:512,
		lowX:-256,
		upX:256,
		lowY:-256,
		upY:256,
		lowZ:-36,
		upZ:46
	}
    scene = K3D.init(heightmap, function () {
		editMode("move")
	})
	scene.setAmbientColor("#999999")
	scene.camera.setLocX(-100)
    
    var purple_mat = doc.getElement("purple");
    var cyan_mat = doc.getElement("cyan");   
    var hoverable = ["ball"]
    var selectable = ["ball"]
    var dragable = ["ball"]
	var dragWallable = []
    g_dragOns = ["bornh_bldg_07_floor", "bornh_bldg_08_floor", "b7_firedoor_door","bornh_bldg_07_walls_int_01",
	"bornh_bldg_07_walls_int_01_sub1","straightstair_smallgallery","straightstair_smallgallery_sub1",
	"bornh_bldg_07_walls_int_02","bornh_bldg_08_wall_int_01", "bornh_bldg_08_wall_int_02",
	"bornh_bldg_08_wall_int_02_sub1","bornh_door_gallery_connector_01", 
	"bornh_bldg_08_wall_int_03","bornh_bldg_07_walls_ext_02_sub1" ]

    // hover cyan
    for (i in hoverable) {
        obj = scene.getObjectById(hoverable[i])
		if (!obj) break
        obj.makeHoverable(function(){
            if (this.highlightMaterial != purple_mat) setHighlightMaterial(this, cyan_mat)
        }, function(){
            if (this.highlightMaterial != purple_mat) setHighlightMaterial(this, null)
        })
        obj.highlightMaterial = null
    }
    
    
    // selected are purple
    for (i in selectable) {
        obj = scene.getObjectById(selectable[i])
		if (!obj) break
        obj.makeSelectable(function(){
            setHighlightMaterial(this, purple_mat)
        }, function(){
            if (this.highlightMaterial == purple_mat) setHighlightMaterial(this, null)
        })
        obj.highlightMaterial = null
    }
    
	var fix = function(v) {
		v = 57.2958*v
		while(v>180) v-=360
		while(v<-180) v+=360
		return v.toFixed(1)
	}

	var show = function(self) {
		//pdebug("edit rotate X="+fix(self.getRotX())+" Y="+fix(self.getRotY())+" Z="+fix(self.getRotZ()),4)
	}

    // drag is modal: move, rotatex, rotatey, rotatez
    for (i in dragable) {
        obj=scene.getObjectById(dragable[i])
		if (!obj) break
		obj.makeDragable(function(){
            this.dragStartLocX = parseFloat(this.getLocX()) ///	wtf? strings?
            this.dragStartLocY = parseFloat(this.getLocY())
            this.dragStartLocZ = parseFloat(this.getLocZ())
            this.dragStartRotX = parseFloat(this.getRotX()) ///	wtf? strings?
            this.dragStartRotY = parseFloat(this.getRotY())
            this.dragStartRotZ = parseFloat(this.getRotZ())
        }, function(dx, dy){
			if (document.input_dragmode.R[1].checked) {
				var ang = scene.camera.getRotY()
				var x = Math.cos(ang - Math.PI)
				var y = Math.sin(ang - Math.PI)
				//			pdebug("x: " + x + "y: " + y + "ang: "+ (parseFloat(ang)-Math.PI),9)
				this.setLocX(this.dragStartLocX - dx * x * 0.05)
				this.setLocY(this.dragStartLocY - dx * y * 0.05)
				this.setLocZ(this.dragStartLocZ - dy * 0.05)
				pdebug("edit move X="+this.getLocX().toFixed(3)+" Y="+this.getLocY().toFixed(3)+" Z="+this.getLocZ().toFixed(3),4)
			}
			if (document.input_dragmode.R[2].checked) {
				this.setRotX(this.dragStartRotX + dy*.01)
				show(this)
			}
			if (document.input_dragmode.R[3].checked) {
				this.setRotY(this.dragStartRotY + dy*.01)
				show(this)
			}
			if (document.input_dragmode.R[4].checked) {
				this.setRotZ(this.dragStartRotZ + dx*.01)
				show(this)
			}
        })
	}
    
    // stop dragging my monkey around! (drag on wall & whatever else is under cursor)
	for (i in dragWallable) {
	    scene.getObjectById(dragWallable[i]).makeDragable(dragWallStart, dragWallUpdate)
	}
}

addPicture = function(id){
	var pic = document.getElementById(id).value
    var obj = K3D.createObjectAndAddToScene("galleryPix_" + pixnum++, doc.getElement("square"), pic, function (tx) {
	    obj.setScaleX(parseFloat(tx.width)*.01)
	    obj.setScaleZ(parseFloat(tx.height)*.01)
		obj.computeBoundingSphere()
	})
	obj.gallerySource = pic
	obj.galleryInfo = "Image source: " + pic
	positionOnWall(obj, 0, 0)
	obj.getMaterial().setSpecular(.4)
	obj.getMaterial().setEmit(1)
    obj.makeDragable(dragWallStart, dragWallUpdate)
    obj.makeHoverable(function(){
		this.getMaterial().setEmit(2.2)
			document.getElementById("galleryInfo").innerHTML = this.galleryInfo
    }, function(){
		this.getMaterial().setEmit(1)        
            document.getElementById("galleryInfo").innerHTML = ""
    })
	
	// force edit mode to move (protect from delete)
	document.input_editmode.R[0].checked = true
	editMode("move")
}

movementButton = function(b) {
	K3D.forceMovement=b
}

movementButtonUp = function(b) {
	K3D.forceMovement=null
}


editMode = function(mode) {
	var s
	switch (mode) {
		case "safe": s = "safe mode: paintings cannot be moved or resized"; break
		case "move": s = "move mode: click on a painting to drag along the wall"; break
		case "resize": s = "resize mode: grab painting in upper right corner to resize"; break
		case "annotate": s = "annotate mode: click on a painting to add & edit comments"; break
		case "delete": s = "delete mode: click on a painting to delete.  Careful, no undo!"; break
	}
	document.getElementById("editInfo").innerHTML = s
}

saveGallery = function() {
	var prec = 3
	var s = "copy text below to save gallery<br>|GalleryBegin;<br>"
	for (var i in K3D.gameScene.objects) {
		var o = K3D.gameScene.objects[i]
		if (o.id.slice(0,11) == "galleryPix_") {
			s += "|" + o.gallerySource
			s += "," + o.getLocX().toFixed(prec) + "," + o.getLocY().toFixed(prec) + "," + o.getLocZ().toFixed(prec)
			s += "," + o.getRotX().toFixed(prec) + "," + o.getRotY().toFixed(prec) + "," + o.getRotZ().toFixed(prec)
			s += "," + o.getScaleX().toFixed(prec)
			s += ";<br>"
		}
	}
	s += "|GalleryEnd;<br>"
	document.getElementById("saveLoadGallery").innerHTML = s
}

loadGallery = function() {
	document.getElementById("saveLoadGallery").innerHTML = 	
	'<input type="text" id="input_load" size="100" value="copy data here"/><br><button  onclick="loadGalleryLoad()" >enter</button>'
}

loadGalleryLoad = function() {
	var load = document.getElementById("input_load").value
	document.getElementById("saveLoadGallery").innerHTML = ""
	console.log("loadGalleryLoad:",load)
	var i = load.indexOf("|GalleryBegin;") + 14
	while (i < load.indexOf("|GalleryEnd;")) {
		if (load[i]=='|') {
			var j = i + load.slice(i+1).indexOf(';') + 1
			var s = load.slice(i+1,j)
			i = j
			var w = s.split(',')
			console.log("load:", w)
		}
		else {
			i++
		}
	}
}

doc.load("bornholm_level.xml")

</script>
<div id="dbg0"></div>
<div id="dbg1"></div>
<div id="dbg2"></div>
<div id="dbg3"></div>
<div id="dbg4"></div>
<div id="dbg5"></div>
<div id="dbg6"></div>
<div id="dbg7"></div>
<div id="dbg8"></div>
<div id="dbg9"></div>
<div id="dbg"></div>
</body></html>
